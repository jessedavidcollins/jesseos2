<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JesseOS 2.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background-color: #121212; color: #e5e5e5; font-family: sans-serif; }
  .card { background-color: #1e1e1e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
  .btn-red { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; }
  .btn-red:hover { background-color: #dc2626; }
  .toast { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; display: none; }
</style>
</head>
<body class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">JesseOS 2.0</h1>
    <button id="btn-settings" class="btn-red">⚙️</button>
  </div>
  <div id="today" class="mb-4 text-lg"></div>

  <!-- Tabs -->
  <div class="flex space-x-2 mb-4">
    <button id="tab-am" class="flex-1 btn-red">AM</button>
    <button id="tab-pm" class="flex-1 bg-gray-700 text-white rounded-md">PM</button>
  </div>

  <!-- AM Card -->
  <div id="am-card" class="card">
    <label>Energy AM: <input id="energy_am" type="number" min="1" max="5" value="4" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Mood AM: <input id="mood_am" type="number" min="1" max="5" value="4" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Drive: <input id="drive" type="number" min="1" max="5" value="3" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Planned Movement:
      <select id="plan_move" class="w-full bg-gray-800 p-2 rounded">
        <option value="Yes" selected>Yes</option>
        <option value="No">No</option>
        <option value="Maybe">Maybe</option>
      </select>
    </label>
  </div>

  <!-- PM Card -->
  <div id="pm-card" class="card hidden">
    <label>Energy PM: <input id="energy_pm" type="number" min="1" max="5" value="3" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Mood PM: <input id="mood_pm" type="number" min="1" max="5" value="3" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Nutrition OK:
      <select id="nutrition_ok" class="w-full bg-gray-800 p-2 rounded">
        <option value="Yes" selected>Yes</option>
        <option value="No">No</option>
      </select>
    </label><br><br>
    <label>Minutes Moved: <input id="move_minutes_manual" type="number" value="" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Connection Today:
      <select id="connection_today" class="w-full bg-gray-800 p-2 rounded">
        <option value="No" selected>No</option>
        <option value="Yes">Yes</option>
      </select>
    </label><br><br>
    <label>Connection Type: <input id="connection_type" type="text" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Connection Quality: <input id="connection_quality" type="number" min="1" max="5" value="3" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
    <label>Notes: <textarea id="note" class="w-full bg-gray-800 p-2 rounded"></textarea></label><br><br>
    <label>Sleep Hours: <input id="sleep_hours_auto" type="number" step="0.1" class="w-full bg-gray-800 p-2 rounded"></label>
  </div>

  <div class="mt-4">
    <button id="btn-submit" class="btn-red w-full">Submit</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Settings Modal -->
  <div id="settings" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="card w-96">
      <h2 class="text-lg font-bold mb-4">Settings</h2>
      <label>API URL: <input id="apiUrl" type="text" value="" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
      <label>Shared Secret: <input id="secret" type="text" value="" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
      <label>Timezone: <input id="tz" type="text" value="America/Chicago" class="w-full bg-gray-800 p-2 rounded"></label><br><br>
      <label>Default Planned Movement:
        <select id="default_plan_move" class="w-full bg-gray-800 p-2 rounded">
          <option value="Yes" selected>Yes</option>
          <option value="No">No</option>
          <option value="Maybe">Maybe</option>
        </select>
      </label><br><br>
      <div class="flex justify-between">
        <button id="btn-close-settings" class="bg-gray-600 text-white px-4 py-2 rounded">Close</button>
        <button id="btn-save-settings" class="btn-red">Save</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const apiUrl = ()=>localStorage.getItem('jesse_api_url')||'https://script.google.com/macros/s/AKfycby7y2tABYMvbHbBuu8Vavm3-Uh1BfYTBhigvaHMZhogfDh272Xme7UAyN9nJOrryluI/exec';
  const secret = ()=>localStorage.getItem('jesse_secret')||'';
  const tz = ()=>localStorage.getItem('jesse_tz')||'America/Chicago';
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); };

  const setTab = (tab)=>{
    if(tab==='am'){
      $('#am-card').classList.remove('hidden');
      $('#pm-card').classList.add('hidden');
      $('#tab-am').classList.add('btn-red'); $('#tab-pm').classList.remove('btn-red');
    } else {
      $('#am-card').classList.add('hidden');
      $('#pm-card').classList.remove('hidden');
      $('#tab-pm').classList.add('btn-red'); $('#tab-am').classList.remove('btn-red');
    }
  };

  const now = new Date();
  $('#today').textContent = now.toLocaleString(undefined,{weekday:'long', month:'short', day:'numeric'});
  setTab(now.getHours() < 12 ? 'am' : 'pm');

  $('#tab-am').onclick=()=>setTab('am');
  $('#tab-pm').onclick=()=>setTab('pm');

  $('#btn-settings').onclick=()=>{
    $('#apiUrl').value=apiUrl();
    $('#secret').value=secret();
    $('#tz').value=tz();
    $('#default_plan_move').value=localStorage.getItem('jesse_default_plan_move')||'Yes';
    $('#settings').classList.remove('hidden');
  };
  $('#btn-close-settings').onclick=()=>$('#settings').classList.add('hidden');
  $('#btn-save-settings').onclick=()=>{
    localStorage.setItem('jesse_api_url',$('#apiUrl').value.trim());
    localStorage.setItem('jesse_secret',$('#secret').value.trim());
    localStorage.setItem('jesse_tz',$('#tz').value.trim()||'America/Chicago');
    localStorage.setItem('jesse_default_plan_move',$('#default_plan_move').value);
    toast('Settings saved');
    $('#settings').classList.add('hidden');
  };

  $('#btn-submit').onclick=async()=>{
    if(!apiUrl()||!secret()) return toast('Set API URL & Secret in Settings');
    const date = new Date().toISOString().slice(0,10);
    const payload = {
      date,
      energy_am: $('#energy_am').value,
      mood_am: $('#mood_am').value,
      drive: $('#drive').value,
      plan_move: $('#plan_move').value,
      energy_pm: $('#energy_pm').value,
      mood_pm: $('#mood_pm').value,
      nutrition_ok: $('#nutrition_ok').value,
      move_minutes_manual: $('#move_minutes_manual').value,
      connection_today: $('#connection_today').value,
      connection_type: $('#connection_type').value,
      connection_quality: $('#connection_quality').value,
      note: $('#note').value,
      sleep_hours_auto: $('#sleep_hours_auto').value
    };
    if(!confirm('Submit this entry?\n'+JSON.stringify(payload,null,2))) return;
    try{
      const res = await fetch(apiUrl(),{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({auth: secret(), data: payload})
      });
      const j = await res.json();
      if(!res.ok) throw new Error(j.error||res.statusText);
      toast('Saved ✓');
    }catch(err){
      console.error(err);
      toast('Save failed: '+ err.message);
    }
  };
})();
</script>
</body>
</html>
